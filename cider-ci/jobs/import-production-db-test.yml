name: Test Import Production-DB

context:
  include: cider-ci/shared/main_context.yml
  tasks:
    test-import:
      include:
        - cider-ci/task_components/database/configure.yml
        - cider-ci/task_components/database/delete.yml
        - cider-ci/task_components/gitcrypt.yml
        - cider-ci/task_components/bundle_rspec_ruby.yml

      load: 5 # we need lots of RAM
      max_trials: 1
      traits:
        ci-g2016-02: yes

      scripts:

        create-database:
          start_when:
            database configured:
              script_key: configure-database
          body: |
            #!/usr/bin/env bash
            set -eux
            createdb "$DATABASE"

        unzip:
          body: gunzip secrets/db_production.yml.gz
          timeout: 5 Minutes
          start_when:
            git crypt unlocked:
              script_key: unlock

        test:
          start_when:
            unziped:
              script_key: unzip
            database created:
              script_key: create-database
          timeout: 5 hours
          body: |
            set -eux
            export PATH=~/.rubies/$RUBY/bin:$PATH
            export ATTACHMENTS_PATH=~/leihs-files/attachments
            export IMAGES_PATH=~/leihs-files/images/attachments
            export PROCUREMENT_ATTACHMENTS_PATH=~/leihs-files/system/procurement/attachments/files
            export PROCUREMENT_IMAGES_PATH=~/leihs-files/system/procurement/main_categories/images
            bundle exec rake db:migrate VERSION=100
            bundle exec rake leihs:dbio:import FILE=secrets/db_production.yml
            bundle exec rake db:migrate
            bundle exec rake db:pg:structure_and_data:dump
            mv db/structure_and_data.pgbin /tmp/db_production.pgbin
